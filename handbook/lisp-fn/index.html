
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A new approach to Emacs - Including TypeScript, Threading, Async I/O, and WebRender.">
      
      
      
      
        <link rel="canonical" href="https://emacs-ng.github.io/emacs-ng/handbook/lisp-fn/">
      
      <link rel="shortcut icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.5">
    
    
      
        <title>lisp-fn - Emacs NG - A new approach to Emacs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.77f3fd56.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.7fa14f5b.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../stylesheets/layout.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lisp-globals" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://emacs-ng.github.io/emacs-ng" title="Emacs NG - A new approach to Emacs" class="md-header__button md-logo" aria-label="Emacs NG - A new approach to Emacs">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Emacs NG - A new approach to Emacs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              lisp-fn
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/emacs-ng/emacs-ng/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    emacs-ng/emacs-ng
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        Home
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../js/using-deno/" class="md-tabs__link">
        Deno/Javascript
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../webrender/" class="md-tabs__link">
      Webrender
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../ng-module/" class="md-tabs__link">
      Dynamic modules
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../faq/" class="md-tabs__link">
      FAQ
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../getting-started/" class="md-tabs__link md-tabs__link--active">
        Native Hackers Handbook
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://emacs-ng.github.io/emacs-ng" title="Emacs NG - A new approach to Emacs" class="md-nav__button md-logo" aria-label="Emacs NG - A new approach to Emacs">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Emacs NG - A new approach to Emacs
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/emacs-ng/emacs-ng/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    emacs-ng/emacs-ng
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      <label class="md-nav__link" for="__nav_1">
        Home
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_2" type="checkbox" id="__nav_1_2" >
      
      <label class="md-nav__link" for="__nav_1_2">
        Setup
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Setup" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_2">
          <span class="md-nav__icon md-icon"></span>
          Setup
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../build/building/" class="md-nav__link">
        Build from source
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../build/docker/" class="md-nav__link">
        Build with Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../build/release/" class="md-nav__link">
        Release .deb package
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../build/nix-develop/" class="md-nav__link">
        Nix Build / Develop
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../package-management/" class="md-nav__link">
        Package management
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Deno/Javascript
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Deno/Javascript" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Deno/Javascript
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../js/using-deno/" class="md-nav__link">
        Using Deno
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../js/getting-started/" class="md-nav__link">
        Getting started
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../js/main-features/" class="md-nav__link">
        Basic features
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../js/adv-features/" class="md-nav__link">
        Advanced features
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../js/architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../webrender/" class="md-nav__link">
        Webrender
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../ng-module/" class="md-nav__link">
        Dynamic modules
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      <label class="md-nav__link" for="__nav_6">
        Native Hackers Handbook
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Native Hackers Handbook" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Native Hackers Handbook
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        Getting started
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../build/" class="md-nav__link">
        Build
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../tests/" class="md-nav__link">
        Tests
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          lisp-fn
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        lisp-fn
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions-with-a-dynamic-number-of-arguments-many" class="md-nav__link">
    Functions with a dynamic number of arguments (MANY)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../types/" class="md-nav__link">
        Types
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions-with-a-dynamic-number-of-arguments-many" class="md-nav__link">
    Functions with a dynamic number of arguments (MANY)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/emacs-ng/emacs-ng/edit/master/docs/handbook/lisp-fn.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="lisp-globals">Lisp globals<a class="headerlink" href="#lisp-globals" title="Permanent link">#</a></h1>
<h2 id="functions">Functions<a class="headerlink" href="#functions" title="Permanent link">#</a></h2>
<p>This remacs documentation compares the C implementation for the <code>atan</code>
function with the ported Rust version. Since emacs-ng isn't about
porting the C code base, this example is only intended to show the
differences. However these features can be used by functions that are
part of new features.</p>
<p>The first thing to look at is <code>atan</code>. It takes an optional second
argument, which makes it interesting. The complicated mathematical
bits, on the other hand, are handled by the standard library. This
allows us to focus on the porting process without getting distracted
by the math.</p>
<p>The Lisp values we are given as arguments are tagged pointers; in this
case they are pointers to doubles. The code has to check the tag and
follow the pointer to retrieve the real values. Note that this code
invokes a C macro (called <code>DEFUN</code>) that reduces some of the
boilerplate. The macro declares a static variable called <code>Satan</code> that
holds the metadata the Lisp compiler will need in order to
successfully call this function, such as the docstring and the pointer
to the <code>Fatan</code> function, which is what the C implementation is named:</p>
<div class="highlight"><pre><span></span><code><span class="n">DEFUN</span> <span class="p">(</span><span class="s">&quot;atan&quot;</span><span class="p">,</span> <span class="n">Fatan</span><span class="p">,</span> <span class="n">Satan</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
       <span class="nl">doc</span><span class="p">:</span> <span class="cm">/* Return the inverse tangent of the arguments.</span>
<span class="cm">If only one argument Y is given, return the inverse tangent of Y.</span>
<span class="cm">If two arguments Y and X are given, return the inverse tangent of Y</span>
<span class="cm">divided by X, i.e. the angle in radians between the vector (X, Y)</span>
<span class="cm">and the x-axis.  */</span><span class="p">)</span>
  <span class="p">(</span><span class="n">Lisp_Object</span> <span class="n">y</span><span class="p">,</span> <span class="n">Lisp_Object</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">double</span> <span class="n">d</span> <span class="o">=</span> <span class="n">extract_float</span> <span class="p">(</span><span class="n">y</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">NILP</span> <span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">atan</span> <span class="p">(</span><span class="n">d</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="kt">double</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">extract_float</span> <span class="p">(</span><span class="n">x</span><span class="p">);</span>
      <span class="n">d</span> <span class="o">=</span> <span class="n">atan2</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="n">make_float</span> <span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><code>extract_float</code> checks the tag (signaling an "invalid argument" error
if it's not the tag for a double), and returns the actual
value. <code>NILP</code> checks to see if the tag indicates that this is a null
value, indicating that the user didn't supply a second argument at
all.</p>
<p>Next take a look at the current Rust implementation. It must also take
an optional argument, and it also invokes a (Rust) macro to reduce the
boilerplate of declaring the static data for the function. However, it
also takes care of all of the type conversions and checks that we need
to do in order to handle the arguments and return value:</p>
<div class="highlight"><pre><span></span><code><span class="sd">/// Return the inverse tangent of the arguments.</span>
<span class="sd">/// If only one argument Y is given, return the inverse tangent of Y.</span>
<span class="sd">/// If two arguments Y and X are given, return the inverse tangent of Y</span>
<span class="sd">/// divided by X, i.e. the angle in radians between the vector (X, Y)</span>
<span class="sd">/// and the x-axis</span>
<span class="cp">#[lisp_fn(min = </span><span class="s">&quot;1&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">atan</span><span class="p">(</span><span class="n">y</span>: <span class="nc">EmacsDouble</span><span class="p">,</span><span class="w"> </span><span class="n">x</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">EmacsDouble</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">EmacsDouble</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">.</span><span class="n">atan</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>You can see that we don't have to check to see if our arguments are of
the correct type, the code generated by the <code>lisp_fn</code> macro does this
for us. We also asked for the second argument to be an
<code>Option&lt;EmacsDouble&gt;</code>. This is the Rust type for a value which is
either a valid double or isn't specified at all. We use a match
statement to handle both cases.</p>
<p>This code is so much better that it's hard to believe just how simple
the implementation of the macro is. It just calls <code>.into()</code> on the
arguments and the return value; the compiler does the rest when it
dispatches this method call to the correct implementation.</p>
<h3 id="attributes">Attributes<a class="headerlink" href="#attributes" title="Permanent link">#</a></h3>
<p>This macro creates the necessary FFI functions and symbols
automatically.  It handles normal functions and functions that take an
arbitrary number of arguments (functions with <code>MANY</code> as the maximum
number of arguments on the C side)</p>
<p>It is used like this:</p>
<div class="highlight"><pre><span></span><code><span class="sd">/// Return the same argument</span>
<span class="cp">#[lisp_fn(name = </span><span class="s">&quot;same&quot;</span><span class="cp">, c_name = </span><span class="s">&quot;same&quot;</span><span class="cp">, min = </span><span class="s">&quot;1&quot;</span><span class="cp">]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">same</span><span class="p">(</span><span class="n">obj</span>: <span class="nc">LispObject</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">LispObject</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">obj</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Here the <code>name</code> argument specifies the <strong>symbol name</strong> that is going
to be use in Emacs Lisp, <code>c_name</code> specifies the name for the <code>Fsame</code>
and <code>Ssame</code> statics used in C, and <code>min</code> specifies the <strong>minimum</strong>
number of arguments that can be passed to this function, the
<strong>maximum</strong> number of arguments is calculated automatically from the
function signature.</p>
<p>All three of these arguments are optional, and have sane defaults.
Default for <code>name</code> is the Rust function name with <code>_</code> replaced by <code>-</code>.
Default for <code>c_name</code> is the Rust function name.  Default for <code>min</code> is
the number of Rust arguments, giving a function without optional
arguments.</p>
<p>In this example the attribute generates the <code>Fsame</code> function that is
going to be called in C, and the <code>Ssame</code> structure that holds the
function information. You still need to register the function with
<code>defsubr</code> to make it visible in Emacs Lisp. To make a function visible
to C you need to export it in the crate root (lib.rs) as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">somemodule</span>::<span class="n">Fsome</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<h3 id="functions-with-a-dynamic-number-of-arguments-many">Functions with a dynamic number of arguments (<code>MANY</code>)<a class="headerlink" href="#functions-with-a-dynamic-number-of-arguments-many" title="Permanent link">#</a></h3>
<p>This attribute handles too the definition of functions that take an
arbitrary number of arguments, these functions can take an arbitrary
number of arguments, but you <em>still can</em> specify a <code>min</code> number of
arguments.</p>
<p>They are created as follows:</p>
<div class="highlight"><pre><span></span><code><span class="sd">/// Returns the first argument.</span>
<span class="cp">#[lisp_fn(min = </span><span class="s">&quot;1&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">first</span><span class="p">(</span><span class="n">args</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="n">LispObject</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">LispObject</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h2 id="variables">Variables<a class="headerlink" href="#variables" title="Permanent link">#</a></h2>
<p>At the end of the C file where the DEFUN is defined there is a called
syms_of.... In this file the C code calls defsubr to setup the link
between the C code and the Lisp engine. When porting a DEFUN from C,
the defsubr call needs to be removed as well. For instance, if
syntax-table-p is being ported then find the line like defsubr
(&amp;Ssyntax_table_p); and remove it. The all Rust functions declared
with lisp_fn have a defsubr line generated for them by the build so
there is nothing to do on the Rust side.  DEFSYM</p>
<p>In C, the DEFSYM macro is used to create an entry in the Lisp symbol
table. These are analogous to global variables in the C/Rust
code. Like defsubr you will most often see these in the
syms_of... functions. When porting DEFUNs check to see if there is a
matching DEFSYM as well. If there is remove it from the C and below
the ported Rust code add a line like this:
def_lisp_sym!(Qsyntax_table_p, "syntax-table-p");.  Lisp Variables</p>
<p>You may also be aware that the C code must quickly and frequently
access the current value of a large number of Lisp variables. To make
this possible, the C code stores these values in global
variables. Yes, lots of global variables. In fact, these aren't just
file globals accessible to only one translation unit, these are static
variables that are accessible across the whole program. We've started
porting these to Rust now as well.</p>
<div class="highlight"><pre><span></span><code><span class="n">DEFVAR_LISP</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;post-self-insert-hook&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Vpost_self_insert_hook</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">doc</span>: <span class="cm">/* Hook run at the end of `self-insert-command&#39;.</span>
<span class="cm">    This is run after inserting the character.  */</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Vpost_self_insert_hook</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Qnil</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Like DEFUN, DEFVAR_LISP takes both a Lisp name and the C name. The C
name becomes the name of the global variable, while the Lisp name is
what gets used in Lisp source code. Setting the default value of this
variable happens in a separate statement, which is fine.</p>
<div class="highlight"><pre><span></span><code><span class="sd">/// Hook run at the end of `self-insert-command&#39;.</span>
<span class="sd">/// This is run after inserting the character.</span>
<span class="n">defvar_lisp</span><span class="o">!</span><span class="p">(</span><span class="n">Vpost_self_insert_hook</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;post-self-insert-hook&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Qnil</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>The Rust version must still take both names (this could be simplified
if we wrote this macro using a procedural macro), but it also takes a
default value. As before, the docstring becomes a comment which all
other Rust tooling will recognize.</p>
<p>You might be interested in how this is implemented as well:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define DEFVAR_LISP(lname, vname, doc)      \</span>
<span class="cp">  do {                      \</span>
<span class="cp">    static struct Lisp_Objfwd o_fwd;        \</span>
<span class="cp">    defvar_lisp (&amp;o_fwd, lname, &amp;globals.f_ ## vname);      \</span>
<span class="cp">  } while (false)</span>
</code></pre></div>
<p>The C macro is not very complicated, but there are two somewhat subtle
points. First, it creates an (uninitialized) static variable called
o_fwd, of type Lisp_Objfwd. This holds the variable's value, which is
a Lisp_Object. It then calls the defvar_lisp function to initialize
the fields of this struct, and also to register the variable in the
Lisp runtime's global environment, making it accessible to Lisp code.</p>
<p>The first subtle point is that every invocation of this marco uses the
same variable name, o_fwd. If you call this macro more than once
inside the same scope, then they would all be the exact same static
variable. Instead the macro body is wrapped inside a do while false
loop so that each one has a separate little scope to live in.</p>
<p>The other subtlty is that the Lisp_Objfwd struct actually only has a
pointer to the value. We still have to allocate some storage for that
value somewhere. We take the address of a field on something called
globals here. That's the real storage location. This globals object is
just a big global struct that holds all the global variables. One day
when Emacs is really multi-threaded, there can be one of these per
thread and a lot of the rest of the code will just work.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[macro_export]</span><span class="w"></span>
<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">defvar_lisp</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$field_name</span>:<span class="nc">ident</span><span class="p">,</span><span class="w"> </span><span class="cp">$lisp_name</span>:<span class="nc">expr</span><span class="p">,</span><span class="w"> </span><span class="cp">$value</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[allow(unused_unsafe)]</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">use</span><span class="w"> </span><span class="cp">$crate</span>::<span class="n">bindings</span>::<span class="n">Lisp_Objfwd</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="k">static</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">o_fwd</span>: <span class="nc">Lisp_Objfwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Lisp_Objfwd</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">type_</span>: <span class="cp">$crate</span>::<span class="n">bindings</span>::<span class="n">Lisp_Fwd_Type</span>::<span class="n">Lisp_Fwd_Obj</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">objvar</span>: <span class="nc">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="cp">$crate</span>::<span class="n">bindings</span>::<span class="n">globals</span><span class="p">.</span><span class="cp">$field_name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="cp">$crate</span>::<span class="n">bindings</span>::<span class="n">defvar_lisp</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">o_fwd</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="fm">concat!</span><span class="p">(</span><span class="cp">$lisp_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">).</span><span class="n">as_ptr</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">libc</span>::<span class="n">c_char</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="cp">$crate</span>::<span class="n">bindings</span>::<span class="n">globals</span><span class="p">.</span><span class="cp">$field_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$value</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The Rust version of this macro is rather longer. Primarily this is
because it takes a lot more typing to get a proper uninitialized value
in a Rust program. Some would argue that all of this typing is a bad
thing, but this is very much an unsafe operation. We're basically
promising very precisely that we know this value is uninitialized, and
that it will be completely and correctly initialized by the end of
this unsafe block.</p>
<p>We then call the same defvar_lisp function with the same values, so
that the Lisp_Objfwd struct gets initialized and registered in exactly
the same way as in the C code. We do have take care to ensure that the
Lisp name of the variable is a null-terminated string though.</p>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">October 2, 2021</span>
    
  </small>
</div>
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../tests/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Tests
            </div>
          </div>
        </a>
      
      
        <a href="../types/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Types
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/emacs-ng/emacs-ng" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.5cf3e710.min.js"></script>
      
    
  </body>
</html>