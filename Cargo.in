[workspace]
members = ["rust_src/remacs-lib", "etc/colors", "rust_src/crates/*"]
exclude = ["rust_src/ng-bindgen"]

[workspace.dependencies]
libc = "0.2"
log = "0.4"
errno = "0.3"
gtk = "0.18"
gdk = "0.18"
gtk-sys = "0.18"
gdk-sys = "0.18"
gdkwayland-sys = "0.18"
gdkx11-sys = "0.18"
parking_lot = "0.12"
fxhash = "0.2"
raw-window-handle = "0.5"
image = "0.24"
cfg_aliases = "0.2"
gleam = "0.15"
winit = { version = "0.29", default-features = false, features = ["rwh_05"]}
arboard = "3.3"
euclid = "0.22"
lazy_static = "1.4"
tokio = "1"
regex = "1.10"

[workspace.dependencies.webrender]
git = "https://github.com/declantsien/webrender.git"
rev = "6766059a74135ee6ff26fd4f0f1f25db5c8e772e"
default-features = false

[workspace.dependencies.webrender_api]
git = "https://github.com/declantsien/webrender.git"
rev = "6766059a74135ee6ff26fd4f0f1f25db5c8e772e"
default-features = false

# Allow unwinding in functions called from C. See
# https://www.reddit.com/r/rust/comments/565q1f/wrote_a_blogpost_from_my_experiences_the_arduous/d8h053m/
[profile.dev]
panic = "abort"

[profile.release]
panic = "abort"
codegen-units = 1
lto = true
# This reduces the binary size from 125M to 70M due
# to Deno inclusion
opt-level = 'z' # Optimize for size

### Root package
[package]
authors = ["emacs-ng members"]
name = "emacsng"
description = "Experimental emacs fork"
license = "GPL-3.0"
version = "0.1.0"
edition = "2018"
build = "rust_src/build.rs"

[dependencies]
libc = "0.2"
remacs-lib = { version = "0.1.0", path = "rust_src/remacs-lib" }
emacs = { version = "0.1.0", path = "rust_src/crates/emacs" }
lisp-util = { version = "0.1.0", path = "rust_src/crates/lisp_util" }
lisp-macros = { version = "0.1.0", path = "rust_src/crates/lisp_macros" }
ng_async = { version = "0.1.0", path = "rust_src/crates/ng_async" }
lsp_json = { version = "0.1.0", path = "rust_src/crates/lsp_json" }
git = { version = "0.1.0", path = "rust_src/crates/git", optional = true }
font = { version = "0.1.0", path = "rust_src/crates/font", optional = true }
ng_module = { version = "0.1.0", path = "rust_src/crates/ng_module", optional = true }
js = { version = "0.1.0", path = "rust_src/crates/js", optional = true }
winit-term = { version = "0.1.0", path = "rust_src/crates/winit-term", optional = true }
clippy = { version = "*", optional = true }
log.workspace = true
tracing = "0.1"

[dependencies.tracing-subscriber]
version = "0.3"
features = [
  "matchers",
  "regex",
  "once_cell",
  "tracing",
  "std",
  "thread_local",
  "env-filter"
]

[dependencies.gl-renderer]
version = "0.1.0"
path = "rust_src/crates/gl-renderer"
default-features = false
optional = true

[build-dependencies]
ng-bindgen = { path = "rust_src/ng-bindgen" }

[lib]
crate-type = ["staticlib"]
path = "rust_src/lib.rs"

[features]
default = [
  @CARGO_DEFAULT_FEATURES@
  @CARGO_CHECKING_FEATURES@
]

# Compile with C xml2 library support.
use-xml2 = []
# Use a window system
window-system = ["emacs/window-system"]
# Use the x11 window system
window-system-x11 = ["window-system", "emacs/window-system-x"]
# Use the nextstep window system
window-system-nextstep = ["window-system", "emacs/window-system-ns"]
# Use the w32 window system
window-system-w32 = ["window-system", "emacs/window-system-w32"]
# Use the haiku window system
window-system-haiku = ["window-system", "emacs/window-system-haiku"]
# Use the pgtk window system
window-system-pgtk = [
  "window-system",
  "emacs/window-system-pgtk",
  @PGTK_EXTRA_FEATURES@
]
# Build with git2rs support
libgit = ["git", "ng-bindgen/libgit"]
# Use the webrender
gl-renderer = [
  "dep:font",
  "ng-bindgen/gl-renderer",
  "dep:gl-renderer",
]
# Use the winit window system on Wayland
window-system-winit = [
  "dep:winit-term",
  "ng-bindgen/window-system-winit",
  "window-system",
  "gl-renderer",
  "emacs/window-system-winit",
]
# Use the winit window system with support for X11
window-system-winit-with-x11 = [
  "window-system-winit",
  "emacs/x11",
]
# Treat warnings as a build error on Travis.
strict = []
# Use JavaScript and Deno
javascript = ["dep:js", "ng-bindgen/javascript"]
# Build with dynamic modules support's extensions.
ng-module = ["dep:ng_module", "ng-bindgen/ng-module"]
# Enable glyphs debugging code.
glyph-debug = ["gl-renderer?/capture"]
profiling = ["gl-renderer?/profiling"]

### Patches

# fontconfig font dirs patch
[patch.crates-io.font-loader]
git = "https://github.com/declantsien/rust-font-loader.git"
# rev = "0a53c767463e13346221ad23fa6dd50cd787cd72"
rev = "9e1776052d906f6cd3b78aa701ffb2d657877830"

# unreleased webp has_animation patch
[patch.crates-io.image]
git = "https://github.com/image-rs/image.git"
rev = "5d031ed19b83d876190123cc6fc8b8b203b32814"
